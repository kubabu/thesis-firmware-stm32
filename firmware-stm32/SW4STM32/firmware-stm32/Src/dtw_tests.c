/*
 * dtw_tests.c
 *
 *  Created on: Sep 20, 2017
 *      Author: kuba
 */
#include "classifiers.h"
#include "tests.h"


void cityblock_tests_1(void) {
	float x[DTW_SEQUENCE_LEN] = {0.0};
	float y[DTW_SEQUENCE_LEN] = {0.0};

//	int16_t size = DTW_SEQUENCE_LEN;

	check_exact_value(cityblock(x, y), 0.0, __FUNCTION__);
}


void cityblock_tests_2(void) {
	float x2[DTW_SEQUENCE_LEN] = {0.0};
	float y2[DTW_SEQUENCE_LEN] = {
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0};
//	int16_t size = DTW_SEQUENCE_LEN;

	check_exact_value(cityblock(x2, y2), 50.0, __FUNCTION__);
}


void fastdtw_tests_0(void) {
	float x[DTW_FEATURES][DTW_SEQUENCE_LEN] = {
			{0.0}, {0.0}, {0.0}, {0.0}, {0.0},
			{0.0}, {0.0}, {0.0}, {0.0}, {0.0},
			{0.0}, {0.0}};

	float y0[DTW_FEATURES][DTW_SEQUENCE_LEN] = {
			{0.0}, {0.0}, {0.0}, {0.0}, {0.0},
			{0.0}, {0.0}, {0.0}, {0.0}, {0.0},
			{0.0}, {0.0}};

	check_exact_value(fastdtw(x, y0), 0.0, "fastdtw test0");
}


void fastdtw_tests_1(void) {
	float x[DTW_FEATURES][DTW_SEQUENCE_LEN] = {
			{0.0}, {0.0}, {0.0}, {0.0}, {0.0},
			{0.0}, {0.0}, {0.0}, {0.0}, {0.0},
			{0.0}, {0.0}};

	float y1[DTW_FEATURES][DTW_SEQUENCE_LEN] = {
			{1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0},
			{1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0},
			{1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0},
			{1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0},
			{1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0},
			{1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0},
			{1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0},
			{1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0},
			{1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0},
			{1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0},
			{1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0},
			{1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0},
	};

	check_exact_value(fastdtw(x, y1), 25.0, __FUNCTION__);
}


void fastdtw_tests_2(void) {
	float x[DTW_FEATURES][DTW_SEQUENCE_LEN] = {
			{0.0}, {0.0}, {0.0}, {0.0}, {0.0},
			{0.0}, {0.0}, {0.0}, {0.0}, {0.0},
			{0.0}, {0.0}};
	float y2[DTW_FEATURES][DTW_SEQUENCE_LEN] = {
			{1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0},
			{0.0}, {0.0}, {0.0}, {0.0}, {0.0},
			{0.0}, {0.0}, {0.0}, {0.0}, {0.0},
			{0.0}
	};

	check_exact_value(fastdtw(x, y2), 2.08333325, __FUNCTION__);
}


void fastdtw_tests_3(void) {
	float x[DTW_FEATURES][DTW_SEQUENCE_LEN] = {
			{0.0}, {0.0}, {0.0}, {0.0}, {0.0},
			{0.0}, {0.0}, {0.0}, {0.0}, {0.0},
			{0.0}, {0.0}};
	float y3[DTW_FEATURES][DTW_SEQUENCE_LEN] = {
			{1.0, 2.0, 3.0, 4.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
			0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
			0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
			0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
			0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
			{0.0}, {0.0}, {0.0}, {0.0}, {0.0},
			{0.0}, {0.0}, {0.0}, {0.0}, {0.0},
			{0}
	};

	check_exact_value(fastdtw(x, y3), 0.416666657, __FUNCTION__);
}

void benchmark_runtimes() {
	char msg[50];

	float x[DTW_FEATURES][DTW_SEQUENCE_LEN] = {
				{0.0}, {0.0}, {0.0}, {0.0}, {0.0},
				{0.0}, {0.0}, {0.0}, {0.0}, {0.0},
				{0.0}, {0.0}};

	float zeros[DTW_SEQUENCE_LEN] = { 0.0 };
	ringbuf_t ringbuf = ringbuf3(DTW_SEQUENCE_LEN, zeros, DTW_SEQUENCE_LEN);
	rbuf_iterator_t iterator = get_iterator(&ringbuf, DTW_SEQUENCE_LEN);
	rbuf_iterator_t data_series[DTW_FEATURES];
	for(int i = 0; i < DTW_FEATURES; ++i) {
		data_series[i] = iterator;
	}

	uint32_t start, duration;
	int16_t result;
	const uint16_t nn_expected_time = 6; 	// was 3 on regular array, 5 on array of itereator pointers
	const uint16_t dtw_expected_time = 33; 	// was 10 / 32... :(

	start = HAL_GetTick();
	result = run_nn_classifier(data_series);
	duration = HAL_GetTick() - start;

	sprintf(msg, "Benchmarking NN classifier: result=%d in %ld [ms]\r\n", result, duration);
	TM_USART_Puts(USART6, msg);
	check_value(duration <= nn_expected_time, duration, nn_expected_time,
				"Benchmarking NN classifier execution time");


	start = HAL_GetTick();
	result = run_dtw_classifier(x);
	duration = HAL_GetTick() - start;

	sprintf(msg, "Benchmarking DTW classifier: result=%d in %ld [ms]\r\n", result, duration);
	TM_USART_Puts(USART6, msg);
	check_value(duration <= dtw_expected_time, duration, dtw_expected_time,
			"Benchmarking DTW classifier execution time");
}


void _run_dtw_tests(void) {
	cityblock_tests_1();
	cityblock_tests_2();
	fastdtw_tests_0();
	fastdtw_tests_1();
	fastdtw_tests_2();
	fastdtw_tests_3();

	benchmark_runtimes();
}

