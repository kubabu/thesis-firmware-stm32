/*
 * dtw_tests.c
 *
 *  Created on: Sep 20, 2017
 *      Author: kuba
 */
#include "classifiers.h"
#include "tests.h"


void cityblock_tests_1(void) {
	float x[DTW_SEQUENCE_LEN] = {0.0};
	float y[DTW_SEQUENCE_LEN] = {0.0};

//	int16_t size = DTW_SEQUENCE_LEN;

	check_exact_value(cityblock(x, y), 0.0, __FUNCTION__);
}


void cityblock_tests_2(void) {
	float x2[DTW_SEQUENCE_LEN] = {0.0};
	float y2[DTW_SEQUENCE_LEN] = {
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0};
//	int16_t size = DTW_SEQUENCE_LEN;

	check_exact_value(cityblock(x2, y2), 50.0, __FUNCTION__);
}


void fastdtw_tests_0(void) {
	float x[DTW_FEATURES][DTW_SEQUENCE_LEN] = {
			{0.0}, {0.0}, {0.0}, {0.0}, {0.0},
			{0.0}, {0.0}, {0.0}, {0.0}, {0.0},
			{0.0}, {0.0}};

	float y0[DTW_FEATURES][DTW_SEQUENCE_LEN] = {
			{0.0}, {0.0}, {0.0}, {0.0}, {0.0},
			{0.0}, {0.0}, {0.0}, {0.0}, {0.0},
			{0.0}, {0.0}};

	check_exact_value(fastdtw(x, y0), 0.0, "fastdtw test0");
}


void fastdtw_tests_1(void) {
	float x[DTW_FEATURES][DTW_SEQUENCE_LEN] = {
			{0.0}, {0.0}, {0.0}, {0.0}, {0.0},
			{0.0}, {0.0}, {0.0}, {0.0}, {0.0},
			{0.0}, {0.0}};

	float y1[DTW_FEATURES][DTW_SEQUENCE_LEN] = {
			{1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0},
			{1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0},
			{1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0},
			{1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0},
			{1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0},
			{1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0},
			{1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0},
			{1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0},
			{1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0},
			{1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0},
			{1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0},
			{1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0},
	};

	check_exact_value(fastdtw(x, y1), 25.0, __FUNCTION__);
}


void fastdtw_tests_2(void) {
	float x[DTW_FEATURES][DTW_SEQUENCE_LEN] = {
			{0.0}, {0.0}, {0.0}, {0.0}, {0.0},
			{0.0}, {0.0}, {0.0}, {0.0}, {0.0},
			{0.0}, {0.0}};
	float y2[DTW_FEATURES][DTW_SEQUENCE_LEN] = {
			{1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
			1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0},
			{0.0}, {0.0}, {0.0}, {0.0}, {0.0},
			{0.0}, {0.0}, {0.0}, {0.0}, {0.0},
			{0.0}
	};

	check_exact_value(fastdtw(x, y2), 2.08333325, __FUNCTION__);
}


void fastdtw_tests_3(void) {
	float x[DTW_FEATURES][DTW_SEQUENCE_LEN] = {
			{0.0}, {0.0}, {0.0}, {0.0}, {0.0},
			{0.0}, {0.0}, {0.0}, {0.0}, {0.0},
			{0.0}, {0.0}};
	float y3[DTW_FEATURES][DTW_SEQUENCE_LEN] = {
			{1.0, 2.0, 3.0, 4.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
			0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
			0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
			0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
			0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
			{0.0}, {0.0}, {0.0}, {0.0}, {0.0},
			{0.0}, {0.0}, {0.0}, {0.0}, {0.0},
			{0}
	};

	check_exact_value(fastdtw(x, y3), 0.416666657, __FUNCTION__);
}


void benchmark_nn_classifier() {
	char msg[50];

	float series[FEATURES][PADDED_SEQ_LEN] = {
					{0.0}, {0.0}, {0.0}, {0.0}, {0.0},
					{0.0}, {0.0}, {0.0}, {0.0}, {0.0},
					{0.0}, {0.0}};

	uint32_t start, duration;
	int16_t result;
	const uint16_t nn_expected_time = 3;

	start = HAL_GetTick();
	result = run_nn_classifier(series);
	duration = HAL_GetTick() - start;

	sprintf(msg, "Benchmarking NN classifier: result=%d in %ld [ms]\r\n", result, duration);
	TM_USART_Puts(USART6, msg);
	check_value(duration <= nn_expected_time, duration, nn_expected_time, __FUNCTION__);
}


void benchmark_dtw_classifier() {
	char msg[50];

	float x[DTW_FEATURES][DTW_SEQUENCE_LEN] = {
				{0.0}, {0.0}, {0.0}, {0.0}, {0.0},
				{0.0}, {0.0}, {0.0}, {0.0}, {0.0},
				{0.0}, {0.0}};

	uint32_t start, duration;
	int16_t result;
	const uint16_t dtw_expected_time = 11;

	start = HAL_GetTick();
	result = run_dtw_classifier(x);
	duration = HAL_GetTick() - start;

	sprintf(msg, "Benchmarking DTW classifier: result=%d in %ld [ms]\r\n", result, duration);
	TM_USART_Puts(USART6, msg);
	check_value(duration <= dtw_expected_time, duration, dtw_expected_time, __FUNCTION__);
}


void benchmark_runtimes() {
	benchmark_nn_classifier();
	benchmark_dtw_classifier();
}

void _run_dtw_tests(void) {
	cityblock_tests_1();
	cityblock_tests_2();
	fastdtw_tests_0();
	fastdtw_tests_1();
	fastdtw_tests_2();
	fastdtw_tests_3();

	benchmark_runtimes();
}

